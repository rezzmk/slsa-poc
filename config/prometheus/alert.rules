groups:
  - name: ddos_detection
    rules:
      # Basic rate limiting
      - alert: HighRequestRate
        expr: rate(http_requests_received_total[1m]) > 1000
        for: 30s
        labels:
          severity: warning
          attack_type: ddos
        annotations:
          summary: "High HTTP request rate detected"
          description: "Request rate exceeds 1000 requests per minute"

      # Request latency increase
      - alert: AbnormalLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 0.5
        for: 2m
        labels:
          severity: warning
          attack_type: ddos
        annotations:
          summary: "Abnormal latency detected"
          description: "95th percentile of request duration is above 0.5 seconds"

      # Connection pool exhaustion
      - alert: ConnectionPoolSaturation
        expr: rate(http_connections_current[1m]) > 500
        for: 1m
        labels:
          severity: critical
          attack_type: ddos
        annotations:
          summary: "Connection pool near saturation"
          description: "Current connection count is abnormally high"

      # Error rate spike
      - alert: ErrorRateSpike
        expr: rate(http_requests_total{status=~"5.."}[1m]) / rate(http_requests_total[1m]) * 100 > 10
        for: 1m
        labels:
          severity: critical
          attack_type: ddos
        annotations:
          summary: "High error rate detected"
          description: "Error rate is above 10%"

      # Memory usage spike
      - alert: MemoryUsageSpike
        expr: process_resident_memory_bytes / 1024 / 1024 > 1000
        for: 2m
        labels:
          severity: warning
          attack_type: ddos
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage exceeds 1GB"

      # Detect potential Slowloris attack
      - alert: SlowlorisAttack
        expr: rate(http_requests_in_progress[5m]) > 100 and rate(http_requests_total[5m]) < 10
        for: 2m
        labels:
          severity: critical
          attack_type: ddos
          subtype: slowloris
        annotations:
          summary: "Potential Slowloris attack detected"
          description: "High number of in-progress requests with low completion rate"
